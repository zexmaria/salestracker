<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Venda</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1f2937; /* Fundo azul-acinzentado escuro */
            margin: 0;
            padding: 0;
            color: #f8f1e8; /* Texto bege claro */
        }
        a {
            text-decoration: none;
            color: #66c2ff; /* Azul claro */
            font-weight: 500;
            transition: color 0.3s ease;
        }
        a:hover {
            color: #33a8ff; /* Azul mais intenso */
        }
        .container {
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #2a3647; /* Fundo em tom azul mais escuro */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        h1 {
            font-size: 2.5rem;
            color: #66c2ff; /* Azul claro */
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            font-size: 1.8rem;
            color: #a3e0ff; /* Azul muito claro */
            margin-bottom: 15px;
            border-left: 5px solid #66c2ff;
            padding-left: 10px;
        }
        form {
            background: linear-gradient(135deg, #2f3e4d, #3a475a);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            margin-bottom: 30px;
        }
        label {
            display: block;
            font-weight: bold;
            color: #d9e2ec;
            margin-top: 10px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #394b5f;
            border-radius: 5px;
            background: #1f2937;
            color: #f8f1e8;
        }
        button {
            background-color: #66cc99; /* Verde claro */
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background-color: #57b889; /* Verde mais escuro */
            transform: translateY(-2px);
        }
        .produto-row {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .produto-row input, .produto-row select {
            width: 48%;
        }
        .submit-btn {
            background-color: #66cc99; /* Verde claro */
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #394b5f;
        }
        th {
            background-color: #394b5f;
            color: #a3e0ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cadastrar Venda</h1>
        <form id="venda-form" method="POST" action="/cadastrar_venda/">
            {% csrf_token %}
            <!-- Cliente -->
            <label for="cliente">Cliente:</label>
            <select id="cliente" name="cliente">
                {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                {% endfor %}
            </select>
            <!-- Vendedor -->
            <label for="vendedor">Vendedor:</label>
            <select id="vendedor" name="vendedor">
                {% for vendedor in vendedores %}
                    <option value="{{ vendedor.id }}">{{ vendedor.nome }}</option>
                {% endfor %}
            </select>
            <div id="produtos-container">
                <h2>Venda</h2>
                <!-- Inicialmente vazio; será preenchido pelo JavaScript -->
            </div>
            <button type="submit" class="submit-btn">Cadastrar Venda</button>
        </form>

        <!-- Tabela para exibir dados da API -->
        <h2>Vendas Registradas</h2>
        <table id="vendas-table">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                    <th>Produtos</th>
                    <th>Quantidade</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dados serão inseridos aqui via JavaScript -->
            </tbody>
        </table>

        <!-- Opções de produtos escondidas para duplicar campos -->
        <div id="produtos-options" style="display: none;">
            {% for produto in produtos %}
                <option value="{{ produto.id }}">{{ produto.nome }}</option>
            {% endfor %}
        </div>

        <script>
            // Função para adicionar uma nova linha de produto
            function addNovoProduto() {
                const container = document.getElementById('produtos-container');
                const row = document.createElement('div');
                row.classList.add('produto-row');
                const produtosOptions = document.getElementById('produtos-options').innerHTML;

                row.innerHTML = `
                    <select name="produtos[]" class="produto-select" required>
                        ${produtosOptions}
                    </select>
                    <input type="number" name="quantidades[]" placeholder="Quantidade" min="1" required>
                    <button type="button" class="add-produto" onclick="adicionarProduto(this)">ADD</button>
                `;
                container.appendChild(row);
            }

            // Função acionada ao clicar em "ADD"
            function adicionarProduto(button) {
                const row = button.parentElement;
                const selectProduto = row.querySelector('.produto-select');
                const inputQuantidade = row.querySelector('input[type="number"]');

                if (!selectProduto.value || inputQuantidade.value <= 0) {
                    alert('Por favor, selecione um produto e insira uma quantidade válida.');
                    return;
                }

                // Criar inputs ocultos para enviar os valores ao backend
                const hiddenProduto = document.createElement('input');
                hiddenProduto.type = 'hidden';
                hiddenProduto.name = 'produtos[]';
                hiddenProduto.value = selectProduto.value;

                const hiddenQuantidade = document.createElement('input');
                hiddenQuantidade.type = 'hidden';
                hiddenQuantidade.name = 'quantidades[]';
                hiddenQuantidade.value = inputQuantidade.value;

                row.appendChild(hiddenProduto);
                row.appendChild(hiddenQuantidade);

                // Tornar os campos visíveis somente leitura
                selectProduto.disabled = true;
                inputQuantidade.disabled = true;

                // Alterar o botão para "Adicionado"
                button.disabled = true;
                button.textContent = 'ADICIONADO';

                // Adicionar uma nova linha de produto
                addNovoProduto();
            }

            // Função para buscar vendas da API
            async function carregarVendas() {
                try {
                    const response = await fetch('/api/vendas/'); // Substitua pelo endpoint real da API
                    if (!response.ok) {
                        throw new Error('Erro ao buscar dados da API.');
                    }
                    const vendas = await response.json();

                    const tabela = document.querySelector('#vendas-table tbody');
                    tabela.innerHTML = ''; // Limpar a tabela antes de adicionar novos dados

                    vendas.forEach(venda => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${venda.cliente_nome}</td>
                            <td>${venda.vendedor_nome}</td>
                            <td>${venda.produtos.map(p => `${p.produto_nome} (${p.quantidade})`).join(', ')}</td>
                            <td>${venda.produtos.reduce((acc, p) => acc + p.quantidade, 0)}</td>
                            <td>R$ ${parseFloat(venda.valor_total).toFixed(2)}</td>
                        `;
                        tabela.appendChild(row);
                    });
                } catch (error) {
                    console.error(error);
                    alert('Erro ao carregar vendas. Tente novamente mais tarde.');
                }
            }

            // Inicializar a página com apenas um campo de produto
            document.addEventListener('DOMContentLoaded', () => {
                addNovoProduto();
                carregarVendas(); // Carregar vendas ao abrir a página
            });
        </script>
    </div>
</body>
</html>
